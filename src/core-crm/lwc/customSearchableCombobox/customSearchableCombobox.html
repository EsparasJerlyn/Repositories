<template>
    <div class={formElementClasses}>
        <label
            class="slds-form-element__label"
            for="combobox-id-2"
            if:true={label}
        >
            <abbr if:true={required} class="slds-required" title="required">* </abbr>
            {label}
        </label>
        <div class="slds-form-element__control">
            <div class="slds-combobox_container">
                <div class={classes}>
                    <div
                        class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right"
                        role="none"
                    >
                        <div class="slds-form-element">
                            <template if:false={isSelected}>
                                <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_right ">
                                    <lightning-icon
                                        size="x-small"
                                        class="slds-icon slds-input__icon slds-input__icon_right slds-icon-text-default"
                                        icon-name="utility:search"
                                    ></lightning-icon>
                                    <input
                                        required={required}
                                        type="text"
                                        class={inputClasses}
                                        value={value}
                                        onkeyup={handleChange}
                                        onfocus={handleFocus}
                                        onblur={handleBlur}
                                        onkeydown={handleKeyDown}
                                        oninput={handleInput}
                                        aria-invalid={isInvalid}
                                        aria-describedby="form-error-01"
                                    />
                                </div>
                            </template>
                            <template if:true={isSelected}>
                                <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_left-right" role="none">
                                    <span class="slds-icon_container slds-icon-standard-account slds-combobox__input-entity-icon" title="Account">
                                        <lightning-icon
                                            size="x-small"
                                            class="slds-icon-standard-user slds-icon_container"
                                            icon-name={optionIcon}
                                        ></lightning-icon>
                                    </span>
                                    <div role="combobox" tabindex="0" class="slds-input_faux slds-combobox__input slds-combobox__input-value">
                                        <span class="slds-truncate">{value}</span>
                                    </div>
                                    <button class="slds-button slds-button_icon slds-input__icon slds-input__icon_right" onclick={handleClear} title="Remove selected option">
                                        <lightning-icon
                                            size="x-small"
                                            class="slds-button__icon slds-icon-utility-close slds-icon_container"
                                            icon-name="utility:close"
                                        ></lightning-icon>
                                        <span class="slds-assistive-text">Remove selected option</span>
                                    </button>
                                </div>
                            </template>
                        </div>

                    </div>
                    <div if:false={tempOptions.length} 
                        class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid slds-box slds-box_x-small slds-listbox__item"
                        aria-selected="true" 
                        onmousedown={handleDropdownMouseDown}
                        onmouseup={handleDropdownMouseUp}
                        onmouseleave={handleDropdownMouseLeave}>
                        <ul
                        class="slds-listbox slds-listbox_vertical"
                        role="presentation">
                            <div aria-selected="true" class="slds-box slds-box_small slds-media slds-listbox__option slds-listbox__option_plain slds-media_small slds-has-focus">
                                <p>No matches found</p>
                            </div>
                        </ul>
                    </div>
                    <div
                        if:true={tempOptions.length}
                        class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid"
                        role="listbox"
                        onmousedown={handleDropdownMouseDown}
                        onmouseup={handleDropdownMouseUp}
                        onmouseleave={handleDropdownMouseLeave}
                    >
                        <template if:true={customServerSearch}>
                            <lightning-spinner if:true={searchInProgress} alternative-text="Loading" size="small"></lightning-spinner>
                        </template>
                        <ul
                            class="slds-listbox slds-listbox_vertical"
                            role="presentation"
                        >
                            <template for:each={tempOptions} for:item="option">
                                <li
                                    key={option.value}
                                    role="presentation"
                                    class="slds-listbox__item"
                                >
                                    <div
                                        onclick={handleSelect}
                                        data-value={option.value}
                                        class={option.classes}
                                        role="option"
                                        data-focused={option.focused}
                                    >
                                        <span class="slds-media__figure slds-listbox__option-icon">
                                            <template if:true={optionIcon}>
                                                <lightning-icon
                                                    size="x-small"
                                                    class="slds-icon-standard-user slds-icon_container"
                                                    icon-name={optionIcon}
                                                ></lightning-icon>
                                            </template>
                                        </span>
                                        <span class="slds-media__body">
                                            <span class="slds-truncate" title={option.label}>
                                                <template if:true={option.multipleLabel}>
                                                    <template for:each={option.multipleLabel} for:item="item">
                                                        <span key={item} class="slds-listbox__option-text slds-listbox__option-text_entity">{item}</span>
                                                    </template>
                                                </template>
                                                <template if:false={option.multipleLabel}>
                                                    {option.label}
                                                </template>
                                            </span>
                                        </span>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div
            class="slds-form-element__help"
            if:true={isInvalid}
        >{messageWhenInvalid}</div>
    </div>
</template>