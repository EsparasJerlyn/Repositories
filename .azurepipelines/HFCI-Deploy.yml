name: "HFCI Deploy (Triggered on creation of Hotfix PR)"

resources:
  repositories:
    - repository: SFDX-PIPELINES
      type: bitbucket
      endpoint: Bitbucket_QUT
      name: qutdev/sfdx-pipelines
      ref: main ## PRODUCTION pipeline branch
      #ref: feature/DEPP-2855-navmenufix ## DEV pipeline branch sdf
      trigger: none

# Build pull requests so we can test them
pr:
  autoCancel: true
  drafts: false
  branches:
    include:
      - hotfix/*

#Custom Variables
variables:
  - group: SF_CICD

parameters:
- name: INCLUDE_SANDBOX_REFRESH_STEP_LoadUsers
  displayName: Include Add/Update Test Users
  type: string
  default: "No"
  values:
    - "Yes"
    - "No"

- name: PACKAGE_DEPLOYMENT_DELTA_TYPE
  displayName: Package Deployment Delta Type
  type: string
  default: "Diff from main"
  values:
  - "Diff from main"
  - "Diff from target branch"

- name: TARGET_BRANCH
  displayName: Target Branch
  type: string
  default: main

stages:
  - stage: PiplineJob
    displayName: "Validate"
    lockBehavior: runLatest
    jobs:
      - deployment: Validate
        timeoutInMinutes: 600
        pool:
          vmImage: "ubuntu-latest"
        container: adammbest/sfdx:latest
        environment: "HFCI"
        variables:
          - group: HFCI
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: SFDX-PIPELINES
                - checkout: self
                - task: DownloadSecureFile@1
                  name: jwtKeyfile
                  inputs:
                    secureFile: "server.key"
                - template: yml/templates/sfdx-init.yml@SFDX-PIPELINES
                - template: yml/templates/sfdx-login.yml@SFDX-PIPELINES
                - template: yml/templates/sfdx-build-package.yml@SFDX-PIPELINES
                  parameters:
                    PACKAGE_DEPLOYMENT_DELTA_TYPE: "${{ parameters.PACKAGE_DEPLOYMENT_DELTA_TYPE }}"
                    TARGET_BRANCH: "${{ parameters.TARGET_BRANCH }}"
                - template: yml/templates/sfdx-scan-code.yml@SFDX-PIPELINES
                - template: yml/templates/sfdx-pre-deploy-steps.yml@SFDX-PIPELINES
                - template: yml/templates/sfdx-deploy-and-post-deploy.yml@SFDX-PIPELINES
                  parameters:
                    validateOrDeploy: "Deploy"
                - template: yml/templates/sfdx-deploy-test-users.yml@SFDX-PIPELINES
                  parameters:
                    INCLUDE_SANDBOX_REFRESH_STEP_LoadUsers: "${{ parameters.INCLUDE_SANDBOX_REFRESH_STEP_LoadUsers }}"
                - template: yml/templates/sfdx-logout.yml@SFDX-PIPELINES
